<!--
=========================================================
* Argon Dashboard 2 - v2.0.4
=========================================================

* Product Page: https://www.creative-tim.com/product/argon-dashboard
* Copyright 2022 Creative Tim (https://www.creative-tim.com)
* Licensed under MIT (https://www.creative-tim.com/license)
* Coded by Creative Tim

=========================================================

* The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.
-->

{% load static %}

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <meta
      name="google-signin-client_id"
      content="406482458768-p1dl33hlpektv0192ct8s47iac1s6hd2.apps.googleusercontent.com"
    />
    <link
      rel="apple-touch-icon"
      sizes="76x76"
      href="{% static 'assets/img/apple-icon.png' %}"
    />
    <link
      rel="icon"
      type="image/svg"
      href="{% static 'assets/img/tns-logo.svg' %}"
    />
    <title>EUDR - {% block title %}Title{% endblock %}</title>
    <!--     Fonts and icons     -->
    <link
      href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700"
      rel="stylesheet"
    />
    <!-- Nucleo Icons -->
    <link href="{% static 'assets/css/nucleo-icons.css' %}" rel="stylesheet" />
    <link href="{% static 'assets/css/nucleo-svg.css' %}" rel="stylesheet" />
    <link href="{% static 'assets/css/nucleo-svg.css' %}" rel="stylesheet" />

    <!-- CSS Files -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
    />
    <!-- Font Awesome CSS -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css"
    />
    <!-- Data Table CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/1.13.5/css/dataTables.bootstrap5.min.css"
    />
    <link
      rel="stylesheet"
      type="text/css"
      href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css"
    />
    <link
      id="pagestyle"
      href="{% static 'assets/css/argon-dashboard.css' %}"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"
      integrity="sha512-h9FcoyWjHcOcmEVkxOfTLnmZFWIH0iZhZT1H2TbOq55xssQGEJHEaIm+PgoUaZbRvQTNTluNOEfb1ZRy6D3BOw=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
  </head>

  <body class="g-sidenav-show bg-gray-100">
    <div class="min-height-300 bg-primary position-absolute w-100"></div>
    <aside
      class="sidenav bg-white navbar navbar-vertical navbar-expand-xs border-0 border-radius-xl my-3 fixed-start ms-4"
      id="sidenav-main"
    >
      <div class="sidenav-header">
        <i
          class="fas fa-times p-3 cursor-pointer text-secondary opacity-5 position-absolute end-0 top-0 d-none d-xl-none"
          aria-hidden="true"
          id="iconSidenav"
        ></i>
        <a class="navbar-brand m-0" href="{% url 'index' %}" target="_blank">
          <img
            src="{% static 'assets/img/tns-logo.svg' %}"
            class="navbar-brand-img h-100"
            alt="main_logo"
          />
          <span class="ms-1 font-weight-bold">TerraTrac Validation Portal</span>
        </a>
      </div>
      <hr class="horizontal dark mt-0" />
      <div class="collapse navbar-collapse w-auto" id="sidenav-collapse-main">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a
              class="nav-link {% if active_page == 'index' %}active{% endif %}"
              href="{% url 'index' %}"
            >
              <div
                class="icon icon-shape icon-sm border-radius-md text-center me-2 d-flex align-items-center justify-content-center"
              >
                <i class="ni ni-tv-2 text-primary text-sm opacity-10"></i>
              </div>
              <span class="nav-link-text ms-1">Dashboard</span>
            </a>
          </li>
          <li class="nav-item">
            <a
              class="nav-link {% if active_page == 'validator' %}active{% endif %}"
              href="{% url 'validator' %}"
            >
              <div
                class="icon icon-shape icon-sm border-radius-md text-center me-2 d-flex align-items-center justify-content-center"
              >
                <i class="ni ni-check-bold text-primary text-sm opacity-10"></i>
              </div>
              <span class="nav-link-text ms-1">Validator</span>
            </a>
          </li>
          <li class="nav-item">
            <a
              class="nav-link {% if active_page == 'validated_files' %}active{% endif %}"
              href="{% url 'validated_files' %}"
            >
              <div
                class="icon icon-shape icon-sm border-radius-md text-center me-2 d-flex align-items-center justify-content-center"
              >
                <i class="ni ni-folder-17 text-primary text-sm opacity-10"></i>
              </div>
              <span class="nav-link-text ms-1">Validated Files</span>
            </a>
          </li>
          <li class="nav-item">
            <a
              class="nav-link {% if active_page == 'map' %}active{% endif %}"
              href="{% url 'map' %}"
            >
              <div
                class="icon icon-shape icon-sm border-radius-md text-center me-2 d-flex align-items-center justify-content-center"
              >
                <i class="ni ni-map-big text-primary text-sm opacity-10"></i>
              </div>
              <span class="nav-link-text ms-1">Map</span>
            </a>
          </li>
          <!-- <li class="nav-item">
            <a
              class="nav-link {% if active_page == 'users' %}active{% endif %}"
              href="{% url 'users' %}"
            >
              <div
                class="icon icon-shape icon-sm border-radius-md text-center me-2 d-flex align-items-center justify-content-center"
              >
                <i class="ni ni-single-02 text-primary text-sm opacity-10"></i>
              </div>
              <span class="nav-link-text ms-1">Users</span>
            </a>
          </li> -->
          <li class="nav-item">
            <a class="nav-link" href="{% url 'logout' %}" id="logout">
              <div
                class="icon icon-shape icon-sm border-radius-md text-center me-2 d-flex align-items-center justify-content-center"
              >
                <i
                  class="ni ni-button-power text-primary text-sm opacity-10"
                ></i>
              </div>
              <span class="nav-link-text ms-1">Logout</span>
            </a>
          </li>
        </ul>
        <div class="fixed-bottom mb-4 pe-5">
          <div class="container-fluid">
            <div class="row align-items-center justify-content-lg-between">
              <div class="col-lg-12 mb-lg-0 mb-4 text-muted">
                <div class="copyright text-center text-sm text-lg-start">
                  ©
                  <script>
                    document.write(new Date().getFullYear());
                  </script>
                  , crafted by
                  <a
                    href="https://www.technoserve.org/tns-labs"
                    class="font-weight-bold"
                    target="_blank"
                    >TNS Labs</a
                  >
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </aside>
    <main class="main-content position-relative border-radius-lg min-vh-100">
      <!-- Navbar -->
      <nav
        class="navbar navbar-main navbar-expand-lg px-0 mx-4 shadow-none border-radius-xl"
        id="navbarBlur"
        data-scroll="false"
      >
        <div class="container-fluid py-1 px-3">
          <nav aria-label="breadcrumb">
            <h6 class="font-weight-bolder text-white mb-0">
              {% block additional_title_content %}{% endblock %}
            </h6>
          </nav>
          <div
            class="collapse navbar-collapse mt-sm-0 mt-2 me-md-0 me-sm-4"
            id="navbar"
          >
            <div class="ms-md-auto pe-md-3 d-flex align-items-center"></div>
            <ul class="navbar-nav justify-content-end">
              <li class="nav-item d-flex align-items-center">
                <a
                  href="javascript:;"
                  class="nav-link text-white font-weight-bold px-0"
                  id="dropdownLangButton"
                  data-bs-toggle="dropdown"
                  aria-expanded="false"
                >
                  <i class="fa fa-globe me-sm-1"></i>
                  <span class="d-sm-inline d-none">Language</span>
                  <i class="fa fa-caret-down ms-sm-1"></i>
                </a>
                <ul
                  class="dropdown-menu dropdown-lang dropdown-menu-end"
                  aria-labelledby="dropdownLangButton"
                >
                  <li class="mb-2">
                    <a
                      class="dropdown-item border-radius-md"
                      href="javascript:;"
                      id="en"
                    >
                      English
                    </a>
                  </li>
                  <li class="mb-2">
                    <a
                      class="dropdown-item border-radius-md"
                      href="javascript:;"
                      id="fr"
                    >
                      French
                    </a>
                  </li>
                  <li class="mb-2">
                    <a
                      class="dropdown-item border-radius-md"
                      href="javascript:;"
                      id="rw"
                    >
                      Kinyarwanda
                    </a>
                  </li>
                  <li class="mb-2">
                    <a
                      class="dropdown-item border-radius-md"
                      href="javascript:;"
                      id="es"
                    >
                      Spanish
                    </a>
                  </li>
                  <li class="mb-2">
                    <a
                      class="dropdown-item border-radius-md"
                      href="javascript:;"
                      id="sw"
                    >
                      Swahili
                    </a>
                  </li>
                </ul>
              </li>
              <li class="nav-item d-xl-none ps-3 d-flex align-items-center">
                <a
                  href="javascript:;"
                  class="nav-link text-white p-0"
                  id="iconNavbarSidenav"
                >
                  <div class="sidenav-toggler-inner">
                    <i class="sidenav-toggler-line bg-white"></i>
                    <i class="sidenav-toggler-line bg-white"></i>
                    <i class="sidenav-toggler-line bg-white"></i>
                  </div>
                </a>
              </li>
              <li class="nav-item dropdown px-3 d-flex align-items-center">
                <a
                  href="javascript:;"
                  class="nav-link text-white p-0"
                  id="dropdownMenuButton"
                  data-bs-toggle="dropdown"
                  aria-expanded="false"
                >
                  <i class="fa fa-bell cursor-pointer"></i>
                </a>
              </li>
              <!-- add circled div with logged in username first letter -->
              <li
                class="nav-item d-flex align-items-center"
                title="{{user.username}}"
              >
                <span class="avatar rounded-circle cursor-pointer"
                  ><i class="fas fa-user"></i
                ></span>
              </li>
            </ul>
          </div>
        </div>
      </nav>
      <!-- End Navbar -->
      <div class="w-100 py-4">
        <div class="w-100">{% block content %}{% endblock %}</div>
      </div>
    </main>

    <div id="google_translate_element"></div>

    <form
      id="logout-form"
      method="post"
      action="{% url 'logout' %}"
      style="display: none"
    >
      {% csrf_token %}
    </form>
    <!--   Core JS Files   -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
    <script src="{% static 'assets/js/plugins/perfect-scrollbar.min.js' %}"></script>
    <script src="{% static 'assets/js/plugins/smooth-scrollbar.min.js' %}"></script>
    <script src="{% static 'assets/js/plugins/chartjs.min.js' %}"></script>
    <script>
      // if mapMonde is loaded, ask for user's location and embed it in url
      const mapMonde = document.querySelector("#mapMonde");
      if (mapMonde) {
        // if user allows location, get it and embed it in the url, otherwise, use default location
        if (navigator.geolocation && !window.location.search) {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              const { latitude, longitude } = position.coords;
              window.location.href = `http://127.0.0.1:8000/map/?lat=${latitude}&lon=${longitude}`;
            },
            (error) => {
              window.location.href = `http://127.0.0.1:8000/map/?lat=0.0&lon=0.0`;
            }
          );
        }
      }
    </script>
    <script>
      document
        .getElementById("logout")
        .addEventListener("click", function (event) {
          event.preventDefault();
          document.getElementById("logout-form").submit();
        });
    </script>
    <!-- Font Awesome Icons -->
    <script
      src="https://kit.fontawesome.com/42d5adcbca.js"
      crossorigin="anonymous"
    ></script>
    <script>
      var ctx1 = document.getElementById("chart-line").getContext("2d");

      var gradientStroke1 = ctx1.createLinearGradient(0, 230, 0, 50);

      gradientStroke1.addColorStop(1, "rgba(94, 114, 228, 0.2)");
      gradientStroke1.addColorStop(0.2, "rgba(94, 114, 228, 0.0)");
      gradientStroke1.addColorStop(0, "rgba(94, 114, 228, 0)");
      new Chart(ctx1, {
        type: "line",
        data: {
          labels: [
            "Apr",
            "May",
            "Jun",
            "Jul",
            "Aug",
            "Sep",
            "Oct",
            "Nov",
            "Dec",
          ],
          datasets: [
            {
              label: "Mobile apps",
              tension: 0.4,
              borderWidth: 0,
              pointRadius: 0,
              borderColor: "#5e72e4",
              backgroundColor: gradientStroke1,
              borderWidth: 3,
              fill: true,
              data: [50, 40, 300, 220, 500, 250, 400, 230, 500],
              maxBarThickness: 6,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false,
            },
          },
          interaction: {
            intersect: false,
            mode: "index",
          },
          scales: {
            y: {
              grid: {
                drawBorder: false,
                display: true,
                drawOnChartArea: true,
                drawTicks: false,
                borderDash: [5, 5],
              },
              ticks: {
                display: true,
                padding: 10,
                color: "#fbfbfb",
                font: {
                  size: 11,
                  family: "Open Sans",
                  style: "normal",
                  lineHeight: 2,
                },
              },
            },
            x: {
              grid: {
                drawBorder: false,
                display: false,
                drawOnChartArea: false,
                drawTicks: false,
                borderDash: [5, 5],
              },
              ticks: {
                display: true,
                color: "#ccc",
                padding: 20,
                font: {
                  size: 11,
                  family: "Open Sans",
                  style: "normal",
                  lineHeight: 2,
                },
              },
            },
          },
        },
      });
    </script>
    <script>
      var win = navigator.platform.indexOf("Win") > -1;
      if (win && document.querySelector("#sidenav-scrollbar")) {
        var options = {
          damping: "0.5",
        };
        Scrollbar.init(document.querySelector("#sidenav-scrollbar"), options);
      }
    </script>
    <!-- Github buttons -->
    <script async defer src="https://buttons.github.io/buttons.js"></script>
    <!-- Leaflet -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://ajax.googleapis.com/ajax/libs/earthengine/0.1.365/earthengine-api.min.js"></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"
      integrity="sha512-BwHfrr4c9kmRkLw6iXFdzcdWV/PGkVgiIyIWLLlTSXzWQzxuSg4DiQUCpauz/EWjgk5TYQqX/kvn9pG1NpYfqg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"
      integrity="sha512-dfX5uYVXzyU8+KHqj8bjo7UkOdg18PaOtpa48djpNbZHwExddghZ+ZmzWT06R5v6NSk3ZUfsH6FNEDepLx9hPQ=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script
      type="text/javascript"
      src="https://cdn.jsdelivr.net/npm/toastify-js"
    ></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
    <!-- Data Table JS -->
    <script src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.1.0/js/dataTables.responsive.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.5/js/dataTables.bootstrap5.min.js"></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/Turf.js/0.0.124/turf.min.js"
      integrity="sha512-jpnZ8xGKbS7L9S6d5fk/zDVgF6OoVKLMoEliLxf24BRX+orWhxqJuUcoM+vGmOaozS9dD9ABjQZKAgjjcwTndA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script
      type="text/javascript"
      src="https://oss.sheetjs.com/sheetjs/xlsx.full.min.js"
    ></script>
    <script
      type="text/javascript"
      src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.5.3/jspdf.min.js"
    ></script>
    <script
      type="text/javascript"
      src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.6/jspdf.plugin.autotable.min.js"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"
      integrity="sha512-dlPw+ytv/6JyepmelABrgeYgHI0O+frEwgfnPdXDTOIZz+eDgfW07QXG02/O8COfivBdGNINy+Vex+lYmJ5rxw=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <!-- Control Center for Soft Dashboard: parallax effects, scripts for the example pages etc -->
    <script src="{% static 'assets/js/argon-dashboard.js' %}"></script>
    <!-- google translator API cdn -->
    <script
      type="text/javascript"
      src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"
    ></script>

    <script type="text/javascript">
      function googleTranslateElementInit() {
        const lang = localStorage.getItem("terraTracLang") || "en";
        new google.translate.TranslateElement(
          {
            pageLanguage: "en",
          },
          "google_translate_element"
        );

        changeLanguage(lang);
      }

      // Function to change the language
      function changeLanguage(lang) {
        var translateSelect = document.querySelector(".goog-te-combo");
        if (translateSelect) {
          translateSelect.value = lang;
          translateSelect.dispatchEvent(new Event("change"));

          // save the selected language in the local storage
          localStorage.setItem("terraTracLang", lang);
        }
      }

      // Event listener for language selection
      document.querySelectorAll(".dropdown-item").forEach((item) => {
        item.addEventListener("click", (e) => {
          e.preventDefault();

          // if id is not recognized, go up the tree to find the id
          let id = e.target.id;
          if (id === "") {
            id = e.target.parentElement.parentElement.id;
          }

          if (id !== "") {
            changeLanguage(id);
          }
        });
      });
    </script>

    <script>
      // Add 'active' class to the current menu item
      let currentLocation = window.location.href;
      let links = document.querySelectorAll(".nav-link");
      const selectedDownloadFormat = document.querySelector("#templateFormat");

      selectedDownloadFormat.addEventListener("change", (e) => {
        const selectedFormat = e.target.value;

        if (selectedFormat !== "") {
          window.location.href = `/api/download-template?format%3D${selectedFormat}`;
        }
      });

      links.forEach((link) => {
        if (link.href === currentLocation) {
          link.classList.add("active");
          document.title = link.innerText;
        }
      });
    </script>

    <script>
      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
          const cookies = document.cookie.split(";");
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) === name + "=") {
              cookieValue = decodeURIComponent(
                cookie.substring(name.length + 1)
              );
              break;
            }
          }
        }
        return cookieValue;
      }

      function uploadData() {
        const fileInput = document.getElementById("uploadFile");
        const file = fileInput.files[0];
        const format = file.name.split(".").pop().toLowerCase();
        const file_name = file.name.split(".")[0];

        try {
          const reader = new FileReader();
          reader.onload = function (e) {
            let data;
            if (format === "csv") {
              // Parse CSV data
              data = Papa.parse(e.target.result, { header: true }).data;
            } else if (format === "xlsx" || format === "xls") {
              // Parse Excel data
              const workbook = XLSX.read(e.target.result, { type: "binary" });
              const sheetName = workbook.SheetNames[0];
              data = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], {
                header: 1,
              });
            } else if (format === "geojson") {
              // Parse JSON data
              data = JSON.parse(e.target.result);
            }

            if (data) {
              // Now we have the formatted data
              // Send it to the API
              sendDataToAPI(data, file_name, format);
            } else {
              alert("Invalid file format or file is empty.");
            }
          };

          if (file) {
            reader.readAsText(file);
          } else {
            alert("No file selected.");
          }
        } catch (error) {
          alert("Invalid file format or file is empty.");
        }
      }

      function sendDataToAPI(data, file_name, format) {
        const csrftoken = getCookie("csrftoken");
        const progressContainer = document.querySelector(".progress");
        const progressBar = document.querySelector(".progress-bar");
        const fileInputContainer = document.querySelector("#uploadFile");
        const downloadDropdown = document.querySelector("#templateFormat");
        const saveBtn = document.querySelector("#saveBtn");
        const closeBtn = document.querySelector("#closeBtn");

        progressContainer.style.visibility = "visible";

        saveBtn.setAttribute("disabled", true);
        closeBtn.setAttribute("disabled", true);
        downloadDropdown.setAttribute("disabled", true);
        fileInputContainer.setAttribute("disabled", true);

        fetch("/api/farm/add/", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": csrftoken,
          },
          body: JSON.stringify({
            data: data,
            file_name: file_name,
            format: format,
          }),
        })
          .then((response) => {
            if (!response.ok) {
              if (response.status === 400) {
                return response.json().then((errorData) => {
                  Toastify({
                    text:
                      JSON.stringify(errorData?.errors) || errorData[0].error,
                    duration: 3000,
                    close: true,
                    gravity: "top",
                    position: "right",
                    backgroundColor: "red",
                  }).showToast();
                });
              }
              throw new Error("Network response was not ok.");
            }
            return response.json();
          })
          .then((data) => {
            if (data) {
              Toastify({
                text: "Data uploaded successfully!!!",
                duration: 3000,
                close: true,
                gravity: "top",
                position: "right",
                backgroundColor: "green",
              }).showToast();

              setTimeout(function () {
                window.location.href = `/validator/?file-id=${data[0].file_id}`;
              }, 2000);
            }

            saveBtn.removeAttribute("disabled");
            closeBtn.removeAttribute("disabled");
            fileInputContainer.removeAttribute("disabled");
            downloadDropdown.removeAttribute("disabled");
            progressContainer.style.visibility = "hidden";
          })
          .catch((error) => {
            Toastify({
              text: "Error while uploading data. please try again",
              duration: 3000,
              close: true,
              gravity: "top",
              position: "right",
              backgroundColor: "red",
            }).showToast();

            saveBtn.removeAttribute("disabled");
            closeBtn.removeAttribute("disabled");
            fileInputContainer.removeAttribute("disabled");
            downloadDropdown.removeAttribute("disabled");
            progressContainer.style.visibility = "hidden";
          });
      }
    </script>
    <script>
      let dropArea = document.getElementById("drop-area");

      ["dragenter", "dragover", "dragleave", "drop"].forEach((eventName) => {
        dropArea.addEventListener(eventName, preventDefaults, false);
        document.body.addEventListener(eventName, preventDefaults, false);
      });

      ["dragenter", "dragover"].forEach((eventName) => {
        dropArea.addEventListener(eventName, highlight, false);
      });

      ["dragleave", "drop"].forEach((eventName) => {
        dropArea.addEventListener(eventName, unhighlight, false);
      });

      dropArea.addEventListener("drop", handleDrop, false);

      function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
      }

      function highlight(e) {
        dropArea.classList.add("highlight");
      }

      function unhighlight(e) {
        dropArea.classList.remove("highlight");
      }

      function handleDrop(e) {
        let dt = e.dataTransfer;
        let files = dt.files;
        handleFiles(files);
      }

      function handleFiles(files) {
        [...files].forEach(uploadFile);
      }

      function uploadFile(file) {
        console.log("Uploading...");
      }

      dropArea.addEventListener("click", () => {
        fileElem.click();
      });

      let fileElem = document.getElementById("fileElem");
      fileElem.addEventListener("change", function (e) {
        handleFiles(this.files);
      });
    </script>
    <script>
      const farmsListTitle = document.getElementById("farms_list_title");
      const farmsContainer = document.getElementById("farmsBodyContainer");
      const fileId = new URLSearchParams(window.location.search).get("file-id");
      const collectionSiteDropdown =
        document.querySelector("#csFilterDropdown");
      let farmData = [];
      let filteredFarms = [];

      const colorClasses = {
        low: "low",
        medium: "medium",
        high: "high",
      };

      let response = null;
      if (fileId) {
        fetch(`/api/files/list/${fileId}`)
          .then((response) => {
            if (!response.ok) {
              throw new Error("Network response was not ok");
            }
            return response.json();
          })
          .then((data) => {
            farmsListTitle.innerHTML = `Farms List for ${
              data.file_name.split(".")[0]
            } <i class="fa fa-close bg bg-light p-1 ms-2 rounded-1 cursor-pointer" onclick="window.location.href = '/validator/'"></i>`;
          })
          .catch((error) => {
            console.error(
              "There was a problem with the fetch operation:",
              error
            );
          });
        response = fetch(`/api/farm/list/file/${fileId}`);
      } else {
        response = fetch("/api/farm/list/");
      }

      if (response) {
        response
          .then((resp) => {
            if (!resp.ok) {
              throw new Error("Network response was not ok");
            }
            return resp.json();
          })
          .then((data) => {
            farmData = data;
            filteredFarms = data;

            if (document.querySelector("#total_farms")) {
              document.querySelector("#total_farms").innerText = data.length;
              // check where eudr_risk_level is high and calculate the percentage
              const highRiskFarms = data.filter(
                (farm) => farm.analysis.eudr_risk_level === "high"
              );
              document.querySelector("#farms_rate").innerText = `${
                Number(
                  ((highRiskFarms.length / data.length) * 100).toFixed(2)
                ) || "-"
              }%`;
            }
            if (farmsContainer) {
              if (data.length > 0) {
                document
                  .querySelector("#exportFormatButton")
                  .removeAttribute("disabled");
                // document
                //   .querySelector("#revalidate-all")
                //   .removeAttribute("disabled");

                // get unique collection sites and populate the dropdown
                const collectionSites = [
                  ...new Set(data.map((farm) => farm.collection_site)),
                ];
                collectionSites.forEach((site) => {
                  const option = document.createElement("option");
                  option.value = site;
                  option.innerText = site;
                  collectionSiteDropdown.appendChild(option);
                });
              }

              // remove loading spinner
              farmsContainer.innerHTML = "";

              generateData(data, farmsContainer);
            }
          })
          .catch((error) => {
            console.error(
              "There was a problem with the fetch operation:",
              error
            );
          });
      }

      function viewAnalysis(id) {
        const container = document.getElementById("whispCardsContainer");
        container.innerHTML = "";

        const obj = farmData.find((farm) => farm.id === id);

        Object.keys(obj?.analysis).forEach((key) => {
          const value = obj.analysis[key];

          const card = document.createElement("div");
          card.className = "whisp-item-card";
          card.innerHTML = `
                <h6>${key
                  .replace(/_/g, " ")
                  .replace(/\b\w/g, (char) => char.toUpperCase())}</h6>
                <p class="${
                  key === "eudr_risk_level" && value === "high"
                    ? "bg-gradient bg-success rounded-1 px-2 text-white"
                    : value === "medium"
                    ? "bg-gradient bg-warning rounded-1 px-2 text-white"
                    : value === "low"
                    ? "bg-gradient bg-danger rounded-1 px-2 text-white"
                    : value
                }">${!isNaN(value) && value > 0 ? `${value} ha` : value}</p>
        `;
          container.appendChild(card);
        });

        const whispDataModal = new bootstrap.Modal(
          document.getElementById("whispAnalysisModal"),
          {
            backdrop: "static",
            keyboard: false,
          }
        );

        whispDataModal.show();
      }

      // filter farms by collection site, if all sites are selected, show all farms, otherwise, show farms for the selected site
      collectionSiteDropdown.addEventListener("change", (e) => {
        $("#farms").DataTable().destroy();
        const selectedSite = e.target.value;
        filteredFarms =
          selectedSite === ""
            ? farmData
            : farmData.filter((farm) => farm.collection_site === selectedSite);

        farmsContainer.innerHTML = "";

        generateData(filteredFarms, farmsContainer);
      });

      async function handleExport(format) {
        const languageCode = localStorage.getItem("terraTracLang") || "en";
        const columns = await loadJsonFile(languageCode);
        const file_names = {
          en: "validated_farms",
          fr: "fermes_validées",
          rw: "ubutaka_bwasuzumwe",
          es: "granjas_validadas",
          sw: "mashamba_yaliyothibitishwa",
        };

        switch (format) {
          case "xls":
            exportToExcel(columns, file_names[languageCode]);
            break;
          case "geojson":
            exportToGeoJSON(columns, file_names[languageCode]);
            break;
          case "pdf":
            exportToPDF(columns, file_names[languageCode]);
            break;
          default:
            break;
        }
      }

      async function exportToExcel(columns, file_name) {
        const data = filteredFarms.map((farm) => {
          const farmData = {};
          Object.keys(columns).forEach((column) => {
            if (column === "analysis") {
              Object.keys(columns[column]).forEach((col) => {
                farmData[columns[column][col]] = farm[column][col];
              });
            } else {
              farmData[columns[column]] = farm[column];
            }
          });
          return farmData;
        });

        const workbook = new ExcelJS.Workbook();
        const worksheet = workbook.addWorksheet("Farms Data");

        // Add image
        const logo = await fetch("/static/assets/img/tns-logo-png.png")
          .then((res) => res.blob())
          .then((blob) => {
            return new File([blob], "logo.png", { type: "image/png" });
          });
        const imageId = workbook.addImage({
          buffer: await logo.arrayBuffer(),
          extension: "png",
        });
        worksheet.addImage(imageId, {
          tl: { col: 2, row: 2 },
          ext: { width: 50, height: 50 },
        });

        // Add title
        worksheet.mergeCells("A1:Z6"); // Merge cells for title
        worksheet.getCell("C7").value = "Terratrac Validation Report";
        worksheet.getCell("C7").font = {
          size: 18,
          bold: true,
          underline: true,
        };
        worksheet.getCell("C7").alignment = {
          vertical: "middle",
          horizontal: "center",
        };

        // Space between title and table data
        worksheet.getRow(9).height = 20;

        // Add data starting from the 4th row
        const headers = Object.keys(data[0]);
        worksheet.addRow(headers);
        data.forEach((farmData) => {
          worksheet.addRow(Object.values(farmData));
        });

        // Save file
        const buffer = await workbook.xlsx.writeBuffer();
        const blob = new Blob([buffer], {
          type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
        });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `${file_name}_${new Date().toISOString()}.xlsx`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      }

      function exportToGeoJSON(columns, file_name) {
        let properties = {};
        const features = filteredFarms.map((farm) => {
          properties = {};

          // Iterate over the columns
          Object.keys(columns).forEach((column) => {
            // Check if the column is "analysis"
            if (column === "analysis") {
              properties[column] = {};
              // Iterate over the keys in the "analysis" column
              Object.keys(columns[column]).forEach((col) => {
                // Assign the values from the farm object to the properties object
                properties[columns[column][col]] = farm[column][col];
              });
            } else {
              // Directly assign the values for other columns
              properties[columns[column]] = farm[column];
            }
          });
          return {
            type: "Feature",
            properties,
            geometry: {
              type: farm.polygon ? "Polygon" : "Point",
              coordinates: farm.polygon
                ? farm.polygon
                : [farm.longitude, farm.latitude],
            },
          };
        });

        const geoJSON = {
          type: "FeatureCollection",
          features: features,
        };

        const blob = new Blob([JSON.stringify(geoJSON)], {
          type: "application/json",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `${file_name}_${new Date().toISOString()}.geojson`;
        a.click();
      }

      function exportToPDF(columns, file_name) {
        const doc = new jsPDF({
          orientation: "landscape",
          format: "a4",
        });
        const image = new Image();
        image.src = "/static/assets/img/tns-logo-png.png";
        doc.addImage(image, "PNG", 140, 10, 20, 20);

        // Add the title
        const title = "Validated Farms";
        doc.setFontSize(18); // Set font size
        const pageWidth = doc.internal.pageSize.getWidth();
        const textWidth = doc.getTextWidth(title);
        const x = (pageWidth - textWidth) / 2; // Center the text
        doc.text(title, x, 40); // Adjust the y position as needed

        doc.autoTable({
          startY: 50,
          columns: [
            ...Object.keys(columns)
              .map((column) =>
                column === "analysis"
                  ? Object.keys(columns[column]).map(
                      (col) => columns[column][col]
                    )
                  : columns[column]
              )
              .flat(1),
          ],
          body: [
            ...filteredFarms.map((farm) => {
              const farmData = [];
              Object.keys(columns).forEach((column) => {
                if (column === "analysis") {
                  Object.keys(columns[column]).forEach((col) => {
                    farmData.push(farm[column][col]);
                  });
                } else {
                  farmData.push(farm[column]);
                }
              });
              return farmData;
            }),
          ],
          styles: { cellWidth: "wrap", minCellHeight: 10 },
          margin: { top: 10 },
          didDrawCell: (data) => {
            // Adjustments for overflowing cells
            if (data.cell.height > 10) {
              data.cell.textPos.y =
                data.cell.textPos.y - (data.cell.height - 10) / 2;
            }
          },
        });
        doc.save(`${file_name}_${new Date().toISOString()}.pdf`);
      }

      async function loadJsonFile(languageCode) {
        return await fetch("/static/assets/json/exportable_columns.json", {
          cache: "no-cache",
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error("Network response was not ok");
            }
            return response.json();
          })
          .then((data) => data[languageCode] || data["en"])
          .catch((error) => error);
      }

      // re-validate all farms
      document
        .querySelector("#revalidate-all")
        .addEventListener("click", () => {
          const csrftoken = getCookie("csrftoken");
          const progressOverlay = document.querySelector(".progress-overlay");
          const revalidateProgress = document.querySelector(
            ".revalidate-progress"
          );
          const revalidateBtn = document.querySelector("#revalidate-all");
          // const exportBtn = document.querySelector("#export-btn");

          progressOverlay.style.visibility = "visible";
          revalidateProgress.style.visibility = "visible";

          revalidateBtn.setAttribute("disabled", true);
          // exportBtn.setAttribute("disabled", true);

          fetch("/api/farm/revalidate/", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": csrftoken,
            },
            body: JSON.stringify({
              file_id: fileId,
            }),
          })
            .then((response) => {
              if (!response.ok) {
                throw new Error("Network response was not ok.");
                progressOverlay.style.visibility = "hidden";
                revalidateProgress.style.visibility = "hidden";
              }
              progressOverlay.style.visibility = "hidden";
              revalidateProgress.style.visibility = "hidden";
              return response.json();
            })
            .then((data) => {
              if (data) {
                Toastify({
                  text: "Farms revalidated successfully!!!",
                  duration: 3000,
                  close: true,
                  gravity: "top",
                  position: "right",
                  backgroundColor: "green",
                }).showToast();

                setTimeout(function () {
                  window.location.reload();
                }, 2000);
              }

              revalidateBtn.removeAttribute("disabled");
              // exportBtn.removeAttribute("disabled");
              progressContainer.style.visibility = "hidden";
              revalidateProgress.style.visibility = "hidden";
            })
            .catch((error) => {
              Toastify({
                text: "Error while revalidating farms. please try again",
                duration: 3000,
                close: true,
                gravity: "top",
                position: "right",
                backgroundColor: "red",
              }).showToast();

              revalidateBtn.removeAttribute("disabled");
              // exportBtn.removeAttribute("disabled");
              progressOverlay.style.visibility = "hidden";
              revalidateProgress.style.visibility = "hidden";
            });
        });

      function generateData(farmData, farmsContainer) {
        let i = 0;
        while (i < farmData.length) {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>
              <p class="text-xs text-center font-weight-bold mb-0">${i + 1}.</p>
            </td>
            <td>
              <p class="text-xs font-weight-bold mb-0">${
                farmData[i].geoid || "N/A"
              }</p>
            </td>
            <td>
              <div class="d-flex px-2 py-1">
                <div class="d-flex flex-column justify-content-center">
                  <h6 class="mb-0 text-sm">${farmData[i].farmer_name}</h6>
                </div>
              </div>
            </td>
            <td>
              <p class="text-xs font-weight-bold mb-0">${
                farmData[i].farm_size
              }</p>
            </td>
            <td>
              <p class="text-xs font-weight-bold mb-0">${
                farmData[i].collection_site
              }</p>
            </td>
            <td>
              <p class="text-xs font-weight-bold mb-0">${
                farmData[i].farm_village
              }</p>
            </td>
            <td>
              <p class="text-xs font-weight-bold mb-0">${
                farmData[i].farm_district
              }</p>
            </td>
            <td class="align-middle text-center text-sm">
              <i class="bi bi-eye mt-5 text-primary text-lg" data-toggle="modal" data-target="#whispDataModal"
                id="viewAnalysisBtn" role="button" onclick="viewAnalysis(${
                  farmData[i].id
                })" title="View Analysis"></i>
            </td>
            <td>
              <p class="text-xs font-weight-bold mb-0">${new Date(
                farmData[i].updated_at
              ).toDateString()}</p>
            </td>
            <td class="align-middle text-center">
              <a href="{% url 'map' %}?farm-id=${
                farmData[i].id
              }" class="text-primary font-weight-bold text-lg" title="View on Map"><i class="bi bi-cursor"></i></a>
            </td>
        `;
          farmsContainer.appendChild(tr);
          i++;
        }

        $("#farms").DataTable({
          // add loading spinner while table is being loaded
          processing: true,
          //disable sorting on last column
          columnDefs: [{ orderable: false, targets: 5 }],
          language: {
            //customize pagination prev and next buttons: use arrows instead of words
            paginate: {
              previous: '<span class="fa fa-chevron-left"></span>',
              next: '<span class="fa fa-chevron-right"></span>',
            },
            //customize number of elements to be displayed
            lengthMenu:
              'Display <select class="form-control input-sm">' +
              '<option value="10">10</option>' +
              '<option value="20">20</option>' +
              '<option value="30">30</option>' +
              '<option value="40">40</option>' +
              '<option value="50">50</option>' +
              '<option value="-1">All</option>' +
              "</select> results",
          },
        });
      }
    </script>
    <script>
      const filesContainer = document.getElementById("filesContainer");

      fetch("/api/files/list/")
        .then((response) => {
          if (!response.ok) {
            throw new Error("Network response was not ok");
          }
          return response.json();
        })
        .then((data) => {
          let i = 0;

          if (document.querySelector("#total_files_uploaded")) {
            document.querySelector("#total_files_uploaded").innerText =
              data.length;
          }

          if (filesContainer) {
            // remove loading spinner
            filesContainer.innerHTML = "";

            while (i < data.length) {
              const tr = document.createElement("tr");
              tr.innerHTML = `
                  <td>
                    <p class="text-xs font-weight-bold px-3 mb-0">${i + 1}.</p>
                  </td>
                  <td>
                    <div class="d-flex px-2 py-1">
                      <div class="d-flex justify-content-center align-items-center gap-2">
                        <span class="fas fa-file-alt text-primary text-xs"></span>
                        <h6 class="mb-0 text-sm">${data[i].file_name}</h6>
                      </div>
                    </div>
                  </td>
                  <td>
                    <p class="text-xs font-weight-bold mb-0">${
                      data[i].uploaded_by
                    }</p>
                  </td>
                  <td>
                    <p class="text-xs font-weight-bold mb-0">${new Date(
                      data[i].updated_at
                    ).toLocaleString()}</p>
                  </td>
                  <td>
                    <a
                      href="{% url 'validator' %}?file-id=${data[i].id}"
                      class="text-primary font-weight-bold text-lg me-3"
                      title="View List of Farms"
                      ><i class="bi bi-list"></i></a
                    >
                    <a
                      href="{% url 'map' %}?file-id=${data[i].id}"
                      class="text-primary font-weight-bold text-lg"
                      title="View on Map"
                      ><i class="bi bi-cursor"></i></a
                    >
                  </td>
              `;

              filesContainer.appendChild(tr);
              i++;
            }

            $("#files").DataTable({
              language: {
                //customize pagination prev and next buttons: use arrows instead of words
                paginate: {
                  previous: '<span class="fa fa-chevron-left"></span>',
                  next: '<span class="fa fa-chevron-right"></span>',
                },
                //customize number of elements to be displayed
                lengthMenu:
                  'Display <select class="form-control input-sm">' +
                  '<option value="10">10</option>' +
                  '<option value="20">20</option>' +
                  '<option value="30">30</option>' +
                  '<option value="40">40</option>' +
                  '<option value="50">50</option>' +
                  '<option value="-1">All</option>' +
                  "</select> results",
              },
            });
          }
        })
        .catch((error) => {
          console.error("There was a problem with the fetch operation:", error);
        });
    </script>
  </body>
</html>
